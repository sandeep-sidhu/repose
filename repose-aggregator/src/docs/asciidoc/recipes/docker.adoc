= Docker

With the advent of container technology, Repose can be fully encapsulated and run as a service.

Even though the published Repose Docker image doesn't do a lot by default, this recipe will show you how to tap into some of that power hidden just below the surface.

== Prerequisites
The rest of this recipe assumes you have already completed the <<quick-start.adoc#,Quick Start>> and that you are familiar with how to perform the following on Repose Docker containers and images:

- `create`
- `run`
- `start`
- `stop`
- `inspect`
- `remove`

If you don't have the basics of these operations memorized, then that is fine.
You can always look back at the <<quick-start.adoc#,Quick Start>> anytime you need to.

== Using a Repose Docker Image
All official Repose Docker images are published on Docker Hub at:

image::http://dockeri.co/image/rackerlabs/repose[Repose Docker,link=https://hub.docker.com/r/rackerlabs/repose/]

In the <<quick-start.adoc#,Quick Start>> the Repose instance was left in its default out of the box configuration.
As was seen, it wasn't very useful unless you wanted to go to the Rackspace homepage.
So you are probably wondering how you make a Repose container do cool stuff like <<preventing-xml-bomb.adoc#,Preventing XML bomb attacks>>.

If you already have a Repose configuration that you are migrating to a Docker container, then it is very easy to present it to the container.
If you don't already have a configuration, then see the <<../architecture/configuration.adoc#,Configuration>> page for more details on how to create one.
We also have a series of <<index.adoc#,Recipes>> that will walk you through some of our common use cases and their configurations.

The following command will mount a volume containing a configuration and perform a couple other new options to the `run` command which are explained below.

----
docker run                                   \ <1>
   --detach                                  \ <2>
   --volume /my/config/directory:/etc/repose \ <3>
   --publish 8080:8080                       \ <4>
   --env JAVA_OPTS=-Xmx1024m                 \ <5>
   --name my_repose                          \ <6>
   rackerlabs/repose:latest                    <7>
----
Let's break that command down and take a closer look at what it is doing:

<1> This is the part of the command that tells Docker to create and start a container.
<2> This option will run the container in detached mode.
    In detached mode, the container will run in the background.
    If we were to run in attached mode (the default) instead of detached mode, the terminal we used to execute this command would receive all of the output (i.e., STDIN, STDOUT, and STDERR) from the container.
<3> This option defines a volume that is mounted from the host (i.e., the OS running Docker) onto the Docker container.
    The volume mapping format is `HOST_DIRECTORY:CONTAINER_DIRECTORY`.
    So in this case, the contents of `/my/config/directory` on the host will be visible within in the container in the `/etc/repose` directory.
    This allows us to modify configuration files without having to rebuild the Docker image or even restart the Docker container!
<4> This option defines a port mapping between the host (i.e., the OS running Docker) and the Docker container.
    Doing so allows Repose to accept traffic over the specified port from outside of Docker.
    The port mapping format is `HOST_PORT:CONTAINER_PORT`.
    So in this case, traffic on port `8080` of the host will be forwarded to port `8080` of the container.
<5> This option sets the `JAVA_OPTS` environment variable.
    Doing so allows the user to configure the JVM that Repose is running on.
    The value of this environment variable should be valid command-line arguments for the `java` command.
<6> This option names the container so that it's easier to interact with.
<7> This is the Image ID (in `repository:tag` format) to create a container from.
    Remember that Repose images are hosted at Docker Hub, which Docker can use implicitly.
    Otherwise use the `repository:tag` of the image you created.

Now if we wanted to, we could change the Docker options that define the environment that Repose will run in.
If we wanted to forward random ports instead of explicitly declaring the port mapping, we could replace the `--publish 8080:8080` option with `--publish-all` instead.

== Manually Building a Repose Docker Image
The latest version of the Dockerfiles used to build the Repose Docker images published on Docker Hub can be found at:

- https://raw.githubusercontent.com/rackerlabs/repose/master/repose-aggregator/artifacts/docker/src/docker/ubuntu/Dockerfile[Debian/Ubuntu]
- https://raw.githubusercontent.com/rackerlabs/repose/master/repose-aggregator/artifacts/docker/src/docker/centos/Dockerfile[RedHat/Centos]

To build a custom Repose Docker image, follow these steps:

. Acquire a Repose Dockerfile.
.. Clone/Fork the Repose project.
.. cURL/Wget one of the files linked above.
. *Optionally* Modify the Dockerfile.
. Run the following command from the root of the Repose project to build an image based on the Dockerfile for Ubuntu that will provide Repose v8.7.0.2:
+
----
docker build                                             \ <1>
   --build-arg REPOSE_VERSION=8.7.0.2                    \ <2>
   --tag local/repose:v8.7.0.2-ubuntu                    \ <3>
   ./repose-aggregator/artifacts/docker/src/docker/ubuntu/ <4>
----
Let's break that command down and take a closer look at what it is doing:
+
<1> This tells Docker to build an image.
<2> This option is used by the Dockerfile to know what version of Repose to install.
    See our http://www.openrepose.org/versions/latest/release-notes.html[Release Notes] page for a list of available versions.
<3> This option defines the tag to apply to the image.
    It is in `repository:tag` format.
<4> The last parameter is the path to the Repose Dockerfile.
    The Dockerfile itself must exist as a child of the provided directory.
+
[NOTE]
====
This directory will also be treated as the Docker build context.
====
. If the Dockerfile was successfully built, a Docker image should be available within Docker.
Run the following command to show all available images:
+
----
docker images
----

== Building a Repose Docker Image With the build file
The Repose build system expects your Docker Hub credentials to be available at build time.
They can be passed in as build properties or the easier way is to add them to your `~/.gradle/gradle.properties` file:

- `dockerhub.username=<USERNAME>`
- `dockerhub.password=<PASSWORD>`

Then try to build a quick Repose Docker image from the root of the Repose project.
Remember once the image is created, it is removed and thrown away:

----
./gradlew \
    :repose-aggregator:artifacts:docker:buildUbuntuImageLocal \
    -Prepose-version=8.7.0.2
----

This method will not tag the image for you, but is a repeatable mechanism.

== Notices
Custom artifacts are not currently supported by our Docker images.
If you would like to deploy custom code in Repose running in Docker, please http://www.openrepose.org/#contact-us[contact us]!
